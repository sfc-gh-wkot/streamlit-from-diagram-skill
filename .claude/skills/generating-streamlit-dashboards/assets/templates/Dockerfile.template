# SPCS Dockerfile
# Build: docker build --platform linux/amd64 -t app:latest .
# Use 3.11-slim for smaller image + faster push (~20-30s savings)

FROM python:3.11-slim

# Install curl for healthcheck (often missing in slim images)
RUN apt-get update && apt-get install -y --no-install-recommends curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv for fast dependency installation
RUN pip install --no-cache-dir uv

WORKDIR /app

# Copy requirements FIRST for layer caching
# (deps change less often than code)
COPY requirements-spcs.txt .
RUN uv pip install --system --no-cache -r requirements-spcs.txt

# Copy app code LAST (changes most often)
COPY streamlit_app.py .

EXPOSE 8501
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s \
    CMD curl --fail http://localhost:8501/_stcore/health || exit 1
CMD ["streamlit", "run", "streamlit_app.py", \
     "--server.port=8501", "--server.address=0.0.0.0", "--server.headless=true"]
